@model List<CarManagementSystem.WebMVC.Models.OrderViewModel>

@{
	ViewData["Title"] = "UserOrder";
}

<div class="container mt-5">
    <h2 class="mb-4 text-primary"><i class="fas fa-history me-2"></i> Lịch sử giao dịch của bạn</h2>
    <hr />

    @if (Model == null || !Model.Any())
    {
        // Hiển thị khi không có đơn hàng
        <div class="alert alert-info text-center" role="alert">
            <strong>Bạn chưa có đơn hàng nào.</strong> Hãy bắt đầu mua sắm ngay!
            <p class="mt-2"><a asp-controller="ElectricVehicles" asp-action="Index" class="btn btn-primary">Xem sản phẩm</a></p>
        </div>
    }
    else
    {
        // Vòng lặp qua từng đơn hàng
        @foreach (var order in Model.OrderByDescending(o => o.Datetime))
        {
            <div class="card shadow-sm mb-4">

                @* Order Info *@
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-dark">Đơn hàng #@order.Id</strong>
                        <span class="badge @(GetStatusClass(order.Status)) ms-3">@order.Status</span>
                    </div>
                    <div>
                        <small class="text-muted">Ngày đặt: @order.Datetime.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">

                        @* Order Checkout Info *@
                        <div class="col-md-8">
                            <h5 class="card-title text-success">Tổng tiền: @(order.Total.ToString("N0")) VNĐ</h5>
                            <p class="card-text mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i> Giao đến: @order.Address (@order.ZipCode)
                            </p>
                            <p class="card-text mb-1">
                                <i class="fas fa-wallet me-1"></i> Phương thức: @order.PaymentMethod
                            </p>
                            @if (!string.IsNullOrEmpty(order.Note))
                            {
                                <p class="card-text mb-1 text-sm text-secondary">
                                    <i class="fas fa-sticky-note me-1"></i> Ghi chú: @order.Note
                                </p>
                            }
                        </div>

                        @* Order Details *@
                        <div class="col-md-4 text-end d-flex flex-column justify-content-end">

                            @if (order.Status.Equals("PENDING"))
                            {
                                @* Edit Order Button *@
                                <a asp-controller="Order" asp-action="EditOrder" asp-route-orderId="@order.Id" class="btn btn-outline-warning btn-sm mt-2">
                                    <i class="fas fa-pencil-alt me-1"></i> Chỉnh sửa
                                </a>

                                @if (order.PaymentMethod.Equals("COD"))
                                {
                                    @* Cancel Order Button *@
                                    <a asp-controller="Order" asp-action="Delete" asp-route-id="@order.Id" class="btn btn-outline-danger btn-sm mt-2">
                                        <i class="fas fa-pencil-alt me-1"></i> Hủy
                                    </a>
                                }
                            }
                            
                            <button class="btn btn-outline-primary btn-sm mt-2" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseOrder_@order.Id"
                                    aria-expanded="false" aria-controls="collapseOrder_@order.Id">
                                Xem chi tiết (@order.OrderDetails.Count sản phẩm)
                            </button>
                        </div>
                    </div>
                </div>

                @* Chi tiết sản phẩm (Ẩn/Hiện) *@
                <div class="collapse" id="collapseOrder_@order.Id">
                    <div class="card-footer bg-white pt-3">
                        <h6>Chi tiết các sản phẩm:</h6>
                        <ul class="list-group list-group-flush">
                            @foreach (var detail in order.OrderDetails)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                                    <div class="d-flex align-items-center">
                                        <img src="@detail.ElectricVehicle.ImageUrl" alt="Sản phẩm" style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;">
                                        <strong>Sản phẩm @detail.ElectricVehicle.Model</strong>
                                    </div>
                                    <span class="text-muted">x @detail.Quantity</span>
                                    <span class="text-success">@(detail.TotalPrice.ToString("N0")) VNĐ</span>
                                </li>
                            }
                            @if (order.Promotion != null)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center text-danger font-weight-bold p-2">
                                    <i class="fas fa-tag me-1"></i> Giảm giá (@order.Promotion.Code)
                                    <span class="text-danger">- @(order.Promotion.Discount)%</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
    }
</div>

@functions {
    // Hàm hỗ trợ để định dạng màu sắc cho Status
    public string GetStatusClass(string status)
    {
        return status switch
        {
            "SUCCESS" => "bg-success text-white",
            "PENDING" => "bg-warning text-dark",
            "CANCELLED" => "bg-danger text-white",
            _ => "bg-secondary text-white",
        };
    }
}